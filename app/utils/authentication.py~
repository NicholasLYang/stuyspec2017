import functools

from flask import flash, redirect, session

from app import app, models, db
import hashlib

def authenticate(permission_to_check):
    def auth(f0):
        @functools.wraps(f0)
        def wrapper(*args, **kwargs):
            if not 'osis' in session:
                flash('You are not logged in')
                return redirect('index')
            
            user = models.User.query.filter_by(osis = session['osis']).first()
            
            if not user:
                flash('You are not logged in')
                return redirect('index')
            
            if user.check_permission(permission_to_check):
                return f0(*args, **kwargs)
            flash('You do not have permission to view this page')
            return redirect('index')
        return wrapper
    return auth

def get_user():
    if not 'osis' in session:
        return None
    return models.User.query.filter_by(osis = session['osis']).first()

# osis is a string
def authenticate_login(osis, password):
    user = models.User.query.filter_by(osis = osis).first()

    if not user:
        return None
    return user.check_password(password)

def original_password(osis, password):
    osis_hash = hashlib.md5(osis).hexdigest()

    return password == osis_hash
